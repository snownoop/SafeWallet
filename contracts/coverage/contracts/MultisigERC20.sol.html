<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/MultisigERC20.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> MultisigERC20.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>64/64</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">95% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>38/40</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>69/69</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.5.0;
&nbsp;
import './ECDSA.sol';
import "./FirstERC.sol";
import "./SafeMath.sol";
&nbsp;
contract MultisigERC20 {
    
    struct TimeLimits {
        uint256 dailyLimit;
        uint256 spent;
        uint256 timeStart;
        bool set;
    }    
        
    address private owner;
    FirstERC public ERC20Interface; // required to communicate with tokens complying to ERC20 standard 
    mapping(bytes32 =&gt; address) public tokens; // mapping of tokens suppoted by the smart contract 
    mapping(address =&gt; mapping(bytes32 =&gt; uint256)) public tokenBalances; // mapping of token balances for every user    
    mapping(address =&gt; uint256) public transactionNonces; // amount of transactions for every user in this smart contract
    mapping(address =&gt; mapping(bytes32 =&gt; address)) public safetyKeys; // make private when tested
    mapping(address =&gt; mapping(bytes32 =&gt; TimeLimits)) public limits; 
    mapping(address =&gt; uint256) private lastAppearance; // Private to make it harder for malicious users.
    
    modifier onlyOwner { 
      <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == owner);
      _;
    }
    
    constructor() public {
        owner = msg.sender;
    }
    
    // Used to add support for new tokens
    function addNewToken (bytes32 symbol_, address address_) 
        public 
        onlyOwner 
        returns (bool) {  
        tokens[symbol_] = address_;  
      
        return true;  
    }  
      
    // Removing tokens not supported by dapp
    function removeToken(bytes32 symbol_) 
        public
        onlyOwner 
        returns (bool) {  
      require(tokens[symbol_] != address(0), "Can't remove 0 token");  
      
      delete(tokens[symbol_]);  
      
      return true;  
    }  
    
    function setDailyLimit(bytes32 symbol_, uint256 amount_, bytes memory signature_) public {
        bytes32 message = keccak256(abi.encodePacked(msg.sender, symbol_, amount_, transactionNonces[msg.sender]));
        require(owner == ECDSA.recover(message, signature_) || safetyKeys[msg.sender][symbol_] == ECDSA.recover(message, signature_), "Incorrect signature"); 
        limits[msg.sender][symbol_].dailyLimit = amount_;
        limits[msg.sender][symbol_].set = true;
        transactionNonces[msg.sender]++;
        lastAppearance[msg.sender] = block.timestamp; // Updating last time an action was taken by the user 
    }
    
    function withdrawLimit(bytes32 symbol_, bytes memory signature_) public {
        bytes32 message = keccak256(abi.encodePacked(msg.sender, symbol_, transactionNonces[msg.sender]));
        <span class="missing-if-branch" title="else path not taken" >E</span>require(owner == ECDSA.recover(message, signature_) || safetyKeys[msg.sender][symbol_] == ECDSA.recover(message, signature_), "Incorrect signature"); 
        limits[msg.sender][symbol_].dailyLimit = 0;
        limits[msg.sender][symbol_].set = false;
        transactionNonces[msg.sender]++;
        lastAppearance[msg.sender] = block.timestamp; // Updating last time an action was taken by the user 
    }
     
    function depositFunds_xur(bytes32 symbol_, uint256 amount_) public returns (bool) {
        require(tokens[symbol_] != address(0), "Token not registered");  
          
        address contract_ = tokens[symbol_];  
        address from_ = msg.sender;  
         
        ERC20Interface = FirstERC(contract_);  
        
        require(amount_ &lt;= ERC20Interface.allowance(from_, address(this)), "Amount is larger than provided allowance");
&nbsp;
        ERC20Interface.transferFrom(from_, address(this), amount_);  
        
        tokenBalances[from_][symbol_] = SafeMath.add(tokenBalances[from_][symbol_], amount_);
        lastAppearance[msg.sender] = block.timestamp;
        return true;
    }
    
    function depositFunds(address safetyKey_, bytes32 symbol_, uint256 amount_) public returns (bool) {
        require(tokenBalances[msg.sender][symbol_] == 0, "Balance is not zero"); // Registration allowed if there is no token balance for the user
        require(tokens[symbol_] != address(0), "Token not registered");   
          
        address contract_ = tokens[symbol_];  
        address from_ = msg.sender;  
         
        ERC20Interface = FirstERC(contract_);  
        
        require(amount_ &lt;= ERC20Interface.allowance(from_, address(this)), "Amount is larger than provided allowance");
&nbsp;
        ERC20Interface.transferFrom(from_, address(this), amount_);  
        
        tokenBalances[from_][symbol_] = SafeMath.add(tokenBalances[from_][symbol_], amount_);
        safetyKeys[msg.sender][symbol_] = safetyKey_; // Registering backup key
        lastAppearance[msg.sender] = block.timestamp;
        return true;
    }
     
    
    function verifyTransaction__ef
        (
        address to,
        uint256 amount, 
        bytes memory signature,
        bytes32 symbol_
        ) 
        public 
        {
            address from = msg.sender;
            require(tokenBalances[from][symbol_] &gt;= amount, "Not enough balance"); 
            bytes32 message = keccak256(abi.encodePacked(from, to, amount, transactionNonces[from], symbol_));
            require(owner == ECDSA.recover(message, signature) || safetyKeys[from][symbol_] == ECDSA.recover(message, signature), "Incorrect signature"); // Check if the transaction was signed by the owner or safe key
            if (limits[from][symbol_].set == true) {
                if (block.timestamp &gt; limits[from][symbol_].timeStart + 86400) {
                    require(amount &lt;= limits[from][symbol_].dailyLimit, "Transaction amount exceeds daily limit");
                    limits[from][symbol_].timeStart = block.timestamp;
                } else {
                    require(SafeMath.add(limits[from][symbol_].spent, amount) &lt;= limits[from][symbol_].dailyLimit, "Transaction amount exceeds daily limit");
                }
                limits[from][symbol_].spent = SafeMath.add(limits[from][symbol_].spent, amount);
            }
            address contract_ = tokens[symbol_];  
&nbsp;
            ERC20Interface = FirstERC(contract_);
            tokenBalances[from][symbol_] = SafeMath.sub(tokenBalances[from][symbol_] ,amount);
            lastAppearance[msg.sender] = block.timestamp; // Updating last time an action was taken by the user 
            transactionNonces[from]++;
            ERC20Interface.transfer(to, amount);
        }
    
    function recoverFundsToSafeAddress(address from_, address to_, bytes32 symbol_, uint256 amount_) public {
        require(block.timestamp &gt; lastAppearance[from_] + 120, "Not enough time elapsed to recover to backup address"); //Testing that after two minutes funds can be sent to safe address
        require(tokenBalances[from_][symbol_] &gt;= amount_, "Not enough balance");
        require(safetyKeys[from_][symbol_] == to_, "Address is not correct");
        address contract_ = tokens[symbol_];  
        ERC20Interface = FirstERC(contract_);
        tokenBalances[from_][symbol_] = SafeMath.sub(tokenBalances[from_][symbol_] ,amount_);
        ERC20Interface.transfer(to_, amount_);
    }
    
    function recoverFunds(address from_, address to_, bytes32 symbol_, uint256 amount_) public {
        require(block.timestamp &gt; lastAppearance[from_] + 300, "Not enough time elapsed to recover to any address"); //Testing that after five minutes funds can be sent to anyone
        require(tokenBalances[from_][symbol_] &gt;= amount_, "Not enough balance");
        address contract_ = tokens[symbol_];  
        ERC20Interface = FirstERC(contract_);
        tokenBalances[from_][symbol_] = SafeMath.sub(tokenBalances[from_][symbol_] ,amount_);
        ERC20Interface.transfer(to_, amount_);
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Sep 04 2019 11:01:51 GMT+0100 (British Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
